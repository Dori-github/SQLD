# 4. SQL 최적화 기본 원리
## 인덱스 기본 
### 2. 전체 테이블 스캔과 인덱스 스캔
#### [가. 전체 테이블 스캔]
전체 테이블 스캔 : 테이블에 존재하는 모든 데이터를 읽어가면서 조건에 맞으면 결과로서 추출하고 조건에 맞지 않으면 버리는 방식으로 검색하는 것.  
![sql가이드](http://www.dbguide.net/publishing/img/knowledge/SQL_247.jpg)  
#### 옵티마이저의 전체 테이블 스캔 방식 선택 이유
1. SQL 문에 조건이 존재하지 않는 경우
테이블에 존재하는 모든 데이터가 답이 된다는 것이므로 테이블의 모든 블록을 읽으면서 무조건 결과로 반환.
2. SQL 문의 주어진 조건에 사용 가능한 인덱스가 존재하지 않는 경우
인덱스가 존재하지 않는다면 데이터를 엑세스 할 수 있는 방법은 모든 데이터를 읽으면서 주어진 조건을 만족하는지 검사하는 방법 뿐.
3. 옵티마이저의 취사 선택
4. 그 밖의 경우
병렬 처리 방식으로 처리하는 경우, 전체 테이블 스캔 방식의 힌트를 사용한 경우.
#### [나. 인덱스 스캔]
인덱스 스캔 : 인덱스를 구성하는 칼럼 값을 기반으로 데이터를 추출하는 액세스 기법. 
#### 인덱스 스캔 종류
- 인덱스 유일 스캔 : 유일 인덱스를 사용하여 단 하나의 데이터를 추출하는 방식. 여기서 유일 인덱스는 중복을 허락하지 인덱스. '='로 값이 주어진 경우에만 가능한 인덱스 스캔 방식.  

- 인덱스 범위 스캔 : 인덱스를 이용하여 한 건 이상의 데이터를 추출하는 방식. '='이 값으로 주어지지 않은 경우와 비유일 인덱스를 이용하는 모든 액세스방식.  

- 인덱스 역순 범위 스캔 : 인덱스 리프 블록의 양방향 링크를 이용하여 내림차순으로 데이터를 읽는 방식. 최대값을 쉽게 찾을 수 있음.

이외에도 인덱스 전체 스캔, 인덱스 고속 전체 스캔, 인덱스 스킵 스캔 등이 존재.  


![sql가이드](http://www.dbguide.net/publishing/img/knowledge/SQL_248.jpg)  
#### [다. 전체 테이블 스캔과 인덱스 스캔 방식 비교]
#### 규칙 기반 옵티마이저
데이터를 액세스 하는 방법
1. 인덱스 스캔 방식 : 인덱스를 경유해서 읽는 것. 사용 가능한 적절한 인덱스가 존재할 때만 이용 할 수 있는 스캔방식.
2. 전체 테이블 스캔 방식 : 테이블 전체 데이터를 모두 읽으면서 데이터를 추출하는 방식. 인덱스 존재 유무와 상관 없이 항상 이용가능한 스캔 방식.
![sql가이드](http://www.dbguide.net/publishing/img/knowledge/SQL_249.jpg)  

인덱스 스캔 방식은 인덱스를 이용해 몇번 I/O만으로 원하는 데이터를 쉽게 찾을 수 있음. 그러나 전체 테이블 스캔은 모든 데이터를 읽으면서 찾아야하므로 비효율적인 검색 방식.
## 조인 수행 원리
조인 : 두 개 이상 테이블을 하나의 집합으로 만드는 연산.  
SQL 문에서 FROM 절에 두 개 이상 테이블이 나열 될 경우 조인이 수행됨.   
ex) A, B, C 조인 -> A,B 두 테이블을 먼저 조인하면 해당 결과와 나머지 C 테이블을 조인. 
### 1. NL Join
NL Join : 프로그래밍에서 사용하는 중첩된 반복문과 유사한 방식으로 조인 수행.   랜덤 액세스 방식으로 데이터를 읽음.  
외부 테이블 : 반복문 외부에 있는 선행 테이블.    
내부 테이블 : 반복문 내부에 있는 후행 테이블.
```
FOR 선행 테이블 읽음 → 외부 테이블(Outer Table) FOR 후행 테이블 읽음 → 내부 테이블(Inner Table) (선행 테이블과 후행 테이블 조인)
```
#### NL Join 작업 방법
1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음.
2. 선행 테이블의 조인 키 값을 가지고 후행 테이블에서 조인 수행.
3. 선행 테이블의 조건을 만족하는 모든 행에 대해 1번 수행.

### 2. Sort Merge Join
Sort Merge Join : 조인 칼럼을 기준으로 데이터를 정렬하여 조인을 수행. 스캔 방식으로 데이터를 읽음. 넓은 데이터 처리시 사용되는 기법. 비동등 조인에 대해서도 조인이 가능.  
![sql가이드](http://www.dbguide.net/publishing/img/knowledge/SQL_251.jpg)
#### Sort Merge Join 동작순서
1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음.
2. 선행 테이블의 조인 키를 기준으로 정렬 작업 수행.
3. 1-2번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행.
4. 후행 테이블에서 주어진 조건을 만족하는 행을 찾음.
5. 후행 테이블의 조인 키를 기준으로 정렬 작업 수행.
6. 3-4번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행.
7. 정렬된 결과를 이용하여 조인을 수행하며 조인에 성공하면 추출 버퍼에 넣음.

인덱스가 존재 하지 않을 경우에도 사용할 수 있는 조인 기법. 

### 3. Hash Join
Hash Join : 해슁 기법을 사용하여 조인 수행. 조인을 수행할테이블의 조인 칼럼을 기준으로 해쉬 함수를 수행하여 서로 동일한 값을 갖는 것들 사이에 실제값이 같은지 비교하면서 조인 수행.  
![sql가이드](http://www.dbguide.net/publishing/img/knowledge/SQL_252.jpg)
#### Hash Join 동작순서
1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음.
2. 선행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해쉬 테이블 생성시 조인 칼럼과 SELECT 절에서 필요로 하는 칼럼도 함께 저장.
3. 1-2번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행.
4. 후행 테이블에서 주어진 조건을 만족하는 행을 찾음.
5. 후행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 버킷을 찾음. -> 조인 키를 이용해서 실제 조인될 데이터를 찾음.
6. 조인에 성공하면 추출 버퍼에 넣음.
7. 3-5번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해서 반복 수행. 

인덱스가 존재하지 않아도 사용할 수 있는 기법. 동등 조인에서만 사용 가능. 
